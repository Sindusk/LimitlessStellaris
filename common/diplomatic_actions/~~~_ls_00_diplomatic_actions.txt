##########################################################################
# Limitless Stellaris - Diplomatic Actions
##########################################################################

### Key:
### EED - Expanded Espionage and Diplomacy

## Build Spy Network
# Merge between Expanded Mods Base, Scripted Trigger Undercoat
action_build_spy_network = {
	icon = "GFX_envoy_action_build_spy_network"
	auto_accepted = yes
	require_envoy = yes
	envoy_assignment = spy_network
	requires_actor_independence = no
	requires_recipient_independence = no
	action_type = positive
	sound = fc_ui_spy_network_button

	potential = {
		hidden_trigger = {
			is_playable = yes
			from = {
				OR = {
					is_playable = yes
					is_country_type = primitive
				}
				NOR = {
					has_country_flag = fotd_seperatist_country
					AND = {
						OR = { # Expanded Mods Base
							has_country_flag = solarpunk_country
							has_country_flag = primitives_fanatic_purifier # Expanded Mods Base
						}
						is_country_type = primitive
					}
				}
			}
		}
	}

	possible = {
		custom_tooltip = {
			fail_text = "diplomacy_wrong_interference_policy"
			OR = {
				from = { is_playable = yes }
				from = { is_fallen_empire = yes }
				AND = {
					from = { is_country_type = primitive }
					NOT = { has_policy_flag = interference_not_allowed }
				}
			}
		}
		custom_tooltip = {
			fail_text = "BLANK_STRING"
			if = {
				limit = {
					from = {
						is_primitive = no
					}
				}
				from = { is_fallen_empire = no }
			}
		}
	}
}

## Close Borders
# Using Silfae's Portraits version.
action_close_borders = {
	icon = "GFX_diplomacy_status_closed_borders"
	auto_accepted = yes
	requires_actor_independence = no
	requires_recipient_independence = no
	should_show_auto_accept_message_recipient = yes
	#should_notify_all_communications = yes
	action_type = negative

	possible = {
		can_control_access_for = from

		if = {
			limit = {
				from = { has_valid_civic = civic_pompous_purists }
				NOT = { root = { is_overlord_to = from } }
			}
			if = {
				limit = {
					has_intel = {
						who = from
						intel = civics
					}
				}
				custom_tooltip = {
					fail_text = requires_recipient_not_pompous_borders
					always = no
				}
			}
			else = {
				custom_tooltip = {
					fail_text = diplo_action_no_low_intel
					always = no
				}
			}
		}
		if = { # Silfae's Portraits
			limit = { has_country_flag = abandoned_peepboops@from }
			custom_tooltip = {
				fail_text = requires_recipient_not_peepboops_close_borders
				from = { NOT = { has_country_flag = is_peepboops@prev } }
			}
		}
		else_if = { # Silfae's Portraits
			limit = { has_country_flag = is_peepboops@from }
			custom_tooltip = {
				fail_text = requires_actor_not_peepboops_close_borders
				from = { NOT = { has_country_flag = abandoned_peepboops@prev } }
			}
		}
	}
}

## Demand Subjugation
# Merge between Organic Zealots, We Require Border, Ariphaos, EMB, STU
action_demand_subjugation = {
	icon = "GFX_diplomacy_status_has_vassal"
	requires_actor_peace = yes
	requires_recipient_peace = yes
	diplo_view_acceptance_icon = no
	should_notify_all_communications = yes
	requires_recipient_independence = no
	AI_acceptance_base_value = -100 # Ariphaos -50 -> -100
	action_type = aggressive

	potential = {
		hidden_trigger = {
			FROM = {
				NOT = {
					has_overlord = ROOT
				}
			}
		}
	}

	possible = {
		diplomacy_is_not_homicidal = yes # Organic Zealots
		diplomacy_recipient_is_not_pompous = yes # Organic Zealots
		custom_tooltip = {
			fail_text = "requires_recipient_not_in_galactic_empire"
			NAND = {
				has_galactic_emperor = yes
				is_galactic_community_member = no
				from = { is_galactic_community_member = yes }
			}
		}
		custom_tooltip = {
			fail_text = "requires_recipient_not_custodian"
			from = { is_galactic_custodian = no }
		}
		custom_tooltip = {
			fail_text = "requires_recipient_not_gal_emperor"
			from = { is_galactic_emperor = no }
		}
		custom_tooltip = {
			fail_text = "requires_recipient_not_btc"
			from = { has_been_declared_crisis = no }
		}
		custom_tooltip = {
			fail_text = "requires_not_guaranteeing_independence"
			NOT = {
				is_guaranteeing = from
			}
		}
		get_border_test = yes # We Require Borders
	}

	proposable = {
		if = {
			limit = {
				hidden_trigger = { from = { is_country_type = awakened_fallen_empire } }
			}
			hidden_trigger = { always = yes }
		}
	}

	ai_acceptance = { # EMB
		modifier = {
			add = -75
			opinion_level = { who = from level < excellent }
			desc = not_excellent_relations
		}
	}
}

## Establish Embassy
# Merge between Organic Zealots, Ariphaos, EMB, STU
action_embassy = {
	icon = "GFX_embassy_our"
	auto_accepted = no
	diplo_view_acceptance_icon = yes
	requires_recipient_independence = no
	requires_actor_independence = no
	should_notify_all_communications = no
	action_type = positive

	possible = {
		custom_tooltip = {
			fail_text = "DIPLOMACY_STATUS_WAR"
			NOT = { is_at_war_with = from }
		}
		diplomacy_is_not_homicidal = yes # Organic Zealots
		custom_tooltip = {
			fail_text = "HAS_RIVALRY"
			NOR = {
				is_rival = from
				from = { is_rival = prev }
			}
		}
		diplomacy_recipient_is_not_pompous = yes # Organic Zealots
	}

	should_ai_propose = {
		weight = 0

		modifier = {
			add = 1
			has_attitude_behavior = { target = from behavior = trade }
			opinion = { who = from value > 50 }
		}

		modifier = {
			factor = 0
			has_ai_personality_behaviour = isolationist
		}
	}
}

## Improve Relations
# Merge between EED, Ariphaos, Scripted Trigger Undercoat
action_improve_relation = {
	icon = "GFX_diplomacy_improve_relation"
	auto_accepted = yes
	require_envoy = yes
	envoy_assignment = improve_relations
	requires_actor_independence = no
	requires_recipient_independence = no
	action_type = positive

	potential = {
		hidden_trigger = {
			OR = {
				is_country_type = default
				#is_country_type = ds_nomads # DarkSpace
			}
			from = {
				OR = {
					is_country_type = default
					#is_country_type = ds_nomads # DarkSpace
					AND = {
						is_primitive = yes # Undercoat
						NOR = { 
							has_country_flag = solarpunk_country
							has_country_flag = primitives_fanatic_purifier
						}
						current_awareness_level = full
					}
				}
			}
		}
	}

	possible = {
		custom_tooltip = {
			fail_text = "DIPLOMACY_STATUS_WAR"
			NOT = { is_at_war_with = from }
		}
		homicidal_diplomacy_restrictions = { mirror = yes } # Undercoat
		custom_tooltip = {
			fail_text = "ACTION_CANNOT_INTERFERE_POLICY"
			OR = { 
				has_policy_flag = interference_subtle
				has_policy_flag = interference_active
				from = { is_primitive = no } # Undercoat
			}
		}
		custom_tooltip = {
			fail_text = "requires_recipient_not_fotd_seperatist"
			from = { NOT = { has_country_flag =  fotd_seperatist_country@root } }
		}
	}

	proposable = {
		custom_tooltip = {
			fail_text = "requires_envoy_not_harming_relations"
			NOT = { is_harming_relations_with = from }
		}
	}
}

## Harm Relations
# Merge between EED, Scripted Trigger Undercoat
action_harm_relation = {
	icon = "GFX_diplomacy_harm_relation"
	auto_accepted = yes
	require_envoy = yes
	envoy_assignment = harm_relations
	requires_actor_independence = no
	requires_recipient_independence = no
	action_type = negative

	potential = {
		hidden_trigger = {
			is_playable = yes # Undercoat
			from = {
				OR = {
					is_playable = yes # Undercoat
					AND = {
						is_country_type = primitive
						NOR = { 
							has_country_flag = solarpunk_country
							has_country_flag = primitives_fanatic_purifier # EED
						}
						current_awareness_level = full
					}
				}
			}
		}
	}

	possible = {
		custom_tooltip = {
			fail_text = "DIPLOMACY_STATUS_WAR"
			NOT = { is_at_war_with = from }
		}
		homicidal_diplomacy_restrictions = { mirror = yes } # Undercoat
		custom_tooltip = {
			fail_text = "ACTION_CANNOT_INTERFERE_POLICY"
			OR = { 
				has_policy_flag = interference_subtle
				has_policy_flag = interference_active
				from = { is_primitive = no } # Undercoat
			}
		}
		custom_tooltip = {
			fail_text = "requires_recipient_not_fotd_seperatist"
			from = { NOT = { has_country_flag =  fotd_seperatist_country@root } }
		}
	}

	proposable = {
		custom_tooltip = {
			fail_text = "requires_envoy_not_improving_relations"
			NOT = { is_improving_relations_with = from }
		}
	}
}

## Insult
# Merge between EED, Dynamic Political Events
action_insult = {
	icon = "GFX_diplomacy_status_war"
	requires_recipient_independence = no
	requires_actor_independence = no
	auto_accepted = yes
	should_show_auto_accept_message_recipient = yes
	action_type = aggressive

	possible = {
		custom_tooltip = {
			fail_text = "requires_poor_or_worse_opinion"

			OR = {
				opinion_level = { who = from level <= poor }
				AND = { # EED
					opinion_level = { who = from level <= neutral }
					from_has_antagonistic_ethics = yes
				}
				is_fallen_empire = yes
				from = { is_fallen_empire = yes }
				is_harming_relations_with = from # Dynamic Political Events
				has_policy_flag = diplo_stance_belligerent # EED
				has_policy_flag = diplo_stance_supremacist # EED
				from = { is_at_war_with = prev }
			}
		}
	}

	on_accept = {
		if = {
			limit = {
				has_technology = tech_satisfying_insults
				NOT = {
					has_modifier = satisfying_insult_recently
				}
			}
			add_modifier = {
				modifier = satisfying_insult_recently
				days = 1800
			}
			add_resource = { influence = 50}
			country_event = {
				id = fircon.20
				days = 1800
			}
			set_timed_relation_flag = { # Dynamic Political Events
				flag = dpe_insult
				who = from
				days = 3
			}
			from = { # Dynamic Political Events
				country_event = { id = dpe_hw_duel.1 }
			}
		}
	}
}

## Ask To Join Federation
# Merge between Viable Feudalism, EED, MECR, We Require Borders, Scripted Trigger Undercoat
action_ask_to_join_federation = {
	icon = "GFX_diplomacy_status_federation"
	requires_actor_peace = yes
	requires_recipient_peace = yes
	requires_recipient_alliance_vote = yes
	diplo_view_acceptance_icon = yes
	AI_acceptance_base_value = -50
	action_type = positive
	requires_recipient_independence = no # Viable Feudalism

	potential = {
		hidden_trigger = {
			is_fallen_machine_empire = no
			from = { is_fallen_machine_empire = no }
		}
		hidden_trigger = { # We Require Borders
			# No one wants to join an Empire
			from = {
				NAND = {
					has_federation = yes
					federation = { has_federation_type = vf_ef_federation }
					NOT = { is_overlord_to = root }
				}
			}
		}
		hidden_trigger = { # MECR
			if = {
				limit = {
					from = {
						exists = federation
						federation = { has_federation_perk = galactic_confederation_passive }
					}
				}
				from = {
					OR = {
						is_federation_leader = yes
						is_galactic_custodian = yes
					}
				}
			}
		}
	}

	possible = {
		custom_tooltip = { # MECR
			fail_text = "imperium_federation_can_not_ask_to_join"
			from = {
				NOT = { federation = { has_federation_perk = imperium_federation_passive } }
			}
		}
		custom_tooltip = { # MECR
			fail_text = "only_community_member_can_join_galactic_confederation"
			if = {
				limit = { from = { federation = { has_federation_perk = galactic_confederation_passive } } }
				is_galactic_community_member = yes
			}
		}
		custom_tooltip = {
			fail_text = requires_not_subject_or_subject_asking_overlord
			OR = {
				is_subject = no
				AND = {
					is_subject = yes
					from = { is_same_value = root.overlord }
				}
			}
		}
		homicidal_diplomacy_restrictions = { mirror = yes } # Undercoat
		inwards_perfection_diplomacy_restrictions = { mirror_with_intel = yes } # Undercoat
		custom_tooltip = {
			fail_text = "requires_excellent_or_better_opinion"

			OR = {
				opinion_level = { who = from level >= excellent }
				is_improving_relations_with = from
			}
		}
		custom_tooltip = {
			fail_text = requires_actor_to_be_federation_leader
			from = {
				if = {
					limit = {
						federation = {
							OR = {
								has_federation_law = invite_members_president_vote_empire # Viable Feudalism
								has_federation_law = invite_members_president_vote_hegemony
							}
						}
					}
					is_federation_leader = yes
				}
			}
		}
		# Shared Borders
		get_border_test = yes # We Require Borders
	}

	should_ai_propose = { # MECR
		weight = 1
		modifier = { # EED
			factor = 0
			exists = from
			OR = {
				has_opinion_modifier = {
					who = from
					modifier = opinion_new_contact
				}
				from = {
					has_opinion_modifier = {
						who = prev
						modifier = opinion_new_contact
					}
				}
			}
		}
		modifier = { # MECR
			mult = 5
			NOR = {
				has_opinion_modifier = {
					who = from
					modifier = opinion_kicked_from_alliance
				}
				from = {
					has_opinion_modifier = {
						who = root
						modifier = opinion_broke_federation
					}
				}
			}
		}
	}

	ai_acceptance = { # EED
		modifier = {
			add = -100
			OR = {
				has_opinion_modifier = {
					who = from
					modifier = opinion_new_contact
				}
				from = {
					has_opinion_modifier = {
						who = prev
						modifier = opinion_new_contact
					}
				}
			}
			desc = opinion_new_contact
		}
	}
}

## Form Commercial Pact
# Merge between Viable Feudalism, EED, Expanded Gestalts, Scripted Trigger Undercoat
action_form_commercial_pact = {
	icon = "GFX_diplomacy_status_commercial_pact"
	diplo_view_acceptance_icon = yes
	should_notify_all_communications = no # Viable Feudalism yes -> no
	requires_actor_independence = no # Viable Feudalism yes -> no
	requires_recipient_independence = no # Viable Feudalism yes -> no
	AI_acceptance_base_value = -50
	action_type = positive

	should_ai_propose = { # EED
		weight = 1
		modifier = {
			factor = 0
			exists = from
			is_megacorp = no
			OR = {
				has_opinion_modifier = {
					who = from
					modifier = opinion_new_contact
				}
				from = {
					has_opinion_modifier = {
						who = prev
						modifier = opinion_new_contact
					}
				}
			}
		}
	}

	possible = {
		homicidal_diplomacy_restrictions = { mirror = yes } # Undercoat scripted trigger
		inwards_perfection_diplomacy_restrictions = { mirror_with_intel = yes }
		pompous_diplomacy_restrictions = yes
		custom_tooltip = {
			fail_text = "requires_actor_not_gestalt_consciousness"
			OR = {
				is_gestalt = no
    			has_valid_civic = civic_mutualistic_behavior # Expanded Gestalts
    			has_valid_civic = civic_machine_trading # Expanded Gestalts
			}
			
		}
		custom_tooltip = {
			fail_text = "requires_recipient_not_gestalt_consciousness"
			from = {
				OR = {
					is_gestalt = no
    				has_valid_civic = civic_mutualistic_behavior # Expanded Gestalts
    				has_valid_civic = civic_machine_trading # Expanded Gestalts
				}
			}
		}
		custom_tooltip = {
			fail_text = "requires_actor_not_criminal_heritage"
			OR = {
				is_criminal_syndicate = no
				has_civic = civic_shadow_council_megacorp # EED
			}
		}
		if = {
			limit = {
				from = {
					is_criminal_syndicate = yes
					NOT = { has_civic = civic_shadow_council_megacorp } # EED
				}
			}
			if = {
				limit = {
					has_intel = {
						who = from
						intel = civics
					}
				}
				custom_tooltip = {
					fail_text = requires_recipient_not_criminal_heritage
					always = no
				}
			}
			else = {
				custom_tooltip = {
					fail_text = diplo_action_no_low_intel
					always = no
				}
			}
		}
		custom_tooltip = {
			fail_text = "federation_actor_no_separate_treaties"
			NOT = {
				AND = {
					has_federation = yes
					federation = { has_federation_law = treaties_separate_no }
					NOT = { federation = { any_member = { is_same_value = root.from } } }
				}
			}
		}
		custom_tooltip = {
			fail_text = "federation_recipient_no_separate_treaties"
			from = {
				NOT = {
					AND = {
						has_federation = yes
						federation = { has_federation_law = treaties_separate_no }
						NOT = { federation = { any_member = { is_same_value = root } } }
					}
				}
			}
		}
		custom_tooltip = { # EED replaces opinion block
			fail_text = "requires_good_opinion_or_mercantile"

			OR = {
				is_overlord_to = from # Viable Feudalism
				opinion_level = { who = from level >= good }
				AND = {
					opinion_level = { who = from level >= neutral }
					from_has_compatible_ethics = yes
				}
				has_policy_flag = "diplo_stance_mercantile"
				from = { has_policy_flag = "diplo_stance_mercantile" }
			}
		}
	}

	ai_acceptance = {
		modifier = { # EED
			add = -50
			OR = {
				has_opinion_modifier = {
					who = from
					modifier = opinion_new_contact
				}
				from = {
					has_opinion_modifier = {
						who = prev
						modifier = opinion_new_contact
					}
				}
			}
			desc = opinion_new_contact
		}
		modifier = { # EED
			add = 50
			is_megacorp = yes
			desc = auth_corporate
		}
		modifier = { # EED
			add = 50
			is_megacorp = yes
			has_ascension_perk = ap_universal_transactions
			desc = ap_universal_transactions
		}
		modifier = { # EED
			add = 25
			is_xenophobe = no
			from = { is_megacorp = yes }
			desc = auth_corporate
		}
	}
}

## Form Defensive Pact
# Merge between EED, We Require Borders, Scripted Trigger Undercoat
action_form_defensive_pact = {
	icon = "GFX_diplomacy_status_defensive_pact"
	requires_actor_peace = yes
	requires_recipient_peace = yes
	diplo_view_acceptance_icon = yes
	should_notify_all_communications = yes
	AI_acceptance_base_value = -50
	action_type = positive

	should_ai_propose = { # EED
		weight = 1
		modifier = {
			factor = 0
			exists = from
			OR = {
				has_opinion_modifier = {
					who = from
					modifier = opinion_new_contact
				}
				from = {
					has_opinion_modifier = {
						who = prev
						modifier = opinion_new_contact
					}
				}
			}
		}
	}

	potential = {
		hidden_trigger = {
			NOT = { ROOT = { is_overlord_to = FROM } }
		}

		hidden_trigger = {
			NOT = { FROM = { is_overlord_to = ROOT } }
		}
		hidden_trigger = {
			is_subject = no
		}

		hidden_trigger = {
			FROM = { is_subject = no }
		}
	}

	possible = {
		homicidal_diplomacy_restrictions = { mirror = yes } # Undercoat
		inwards_perfection_diplomacy_restrictions = { mirror_with_intel = yes } # Undercoat
		pompous_diplomacy_restrictions = yes # Undercoat
		custom_tooltip = { # EED replaces block for excellent opinion
			fail_text = "requires_excellent_opinion_or_threatened"
			OR = {
				opinion_level = { who = from level >= excellent }
				AND = {
					opinion_level = { who = from level >= good }
					from_has_compatible_ethics = yes
				}
				AND = {
					NOT = { is_threatened_to = FROM }
					any_relation = {
						PREV = { is_threatened_to = PREV }
					}
				}
				FROM = {
					NOT = { is_threatened_to = PREV }
					any_relation = {
						FROM = { is_threatened_to = PREV }
					}
				}
			}
		}
		# Shared Borders
		get_border_test_defense = yes # We Require Borders
	}

	ai_acceptance = {
		modifier = { # EED
			add = -100
			OR = {
				has_opinion_modifier = {
					who = from
					modifier = opinion_new_contact
				}
				from = {
					has_opinion_modifier = {
						who = prev
						modifier = opinion_new_contact
					}
				}
			}
			desc = opinion_new_contact
		}
	}
}

## Form Migration Pact
# Merge between EED, Expanded Gestalts, Scripted Trigger Undercoat
action_form_migration_pact = {
	icon = "GFX_diplomacy_status_migration_pact"
	diplo_view_acceptance_icon = yes
	should_notify_all_communications = yes
	requires_actor_independence = no
	requires_recipient_independence = no
	AI_acceptance_base_value = -50
	action_type = positive

	should_ai_propose = { # EED
		weight = 1
		modifier = {
			factor = 0
			exists = from
			OR = {
				has_opinion_modifier = {
					who = from
					modifier = opinion_new_contact
				}
				from = {
					has_opinion_modifier = {
						who = prev
						modifier = opinion_new_contact
					}
				}
			}
		}
	}

	possible = {
		homicidal_diplomacy_restrictions = { mirror = yes } # Undercoat
		inwards_perfection_diplomacy_restrictions = { mirror_with_intel = yes } # Undercoat
		barbaric_despoilers_diplomacy_restrictions = { mirror_with_intel = yes } # Undercoat
		pompous_diplomacy_restrictions = yes # Undercoat
		pompous_sender_diplomacy_restrictions = yes # Undercoat
		custom_tooltip = {
			fail_text = "requires_actor_not_gestalt_consciousness"
			OR = {
				NOT = { has_ethic = ethic_gestalt_consciousness	}
                has_valid_civic = civic_mutualistic_behavior # Expanded Gestalts
		    } 
		}
		custom_tooltip = {
			fail_text = "requires_recipient_not_gestalt_consciousness"
			from = { 
				OR = {
					NOT = { has_ethic = ethic_gestalt_consciousness	}
					has_valid_civic = civic_mutualistic_behavior # Expanded Gestalts
				} 
		    }
		}
		custom_tooltip = {
			fail_text = "federation_internal_migration"
			NOT = {
				AND = {
					has_federation = yes
					federation = { any_member = { is_same_value = root.from } }
					federation = { has_federation_law = free_migration_yes }
				}
			}
		}
		custom_tooltip = {
			fail_text = "federation_actor_no_separate_treaties"
			NOT = {
				AND = {
					has_federation = yes
					federation = { has_federation_law = treaties_separate_no }
					NOT = { federation = { any_member = { is_same_value = root.from } } }
				}
			}
		}
		custom_tooltip = {
			fail_text = "federation_recipient_no_separate_treaties"
			from = {
				NOT = {
					AND = {
						has_federation = yes
						federation = {
							has_federation_law = treaties_separate_no
						}
						NOT = { federation = { any_member = { is_same_value = root } } }
					}
				}
			}
		}
		custom_tooltip = { # EED replaces good opinion block
			fail_text = "requires_good_opinion_or_xenophile"

			OR = {
				opinion_level = { who = from level >= good }
				AND = {
					opinion_level = { who = from level >= neutral }
					from_has_compatible_ethics = yes
				}
				is_xenophile = yes
				FROM = { is_xenophile = yes }
			}
		}
	}

	ai_acceptance = { # EED
		modifier = {
			add = -75
			OR = {
				has_opinion_modifier = {
					who = from
					modifier = opinion_new_contact
				}
				from = {
					has_opinion_modifier = {
						who = prev
						modifier = opinion_new_contact
					}
				}
			}
			desc = opinion_new_contact
		}
	}
}

## Form Non-Aggression Pact
# Merge between EED, Scripted Trigger Undercoat
action_form_non_aggression_pact = {
	icon = "GFX_diplomacy_status_non_aggression_pact"
	diplo_view_acceptance_icon = yes
	should_notify_all_communications = yes
	AI_acceptance_base_value = -50
	action_type = positive

	should_ai_propose = { # EED
		weight = 1
		modifier = {
			factor = 0
			exists = from
			OR = {
				has_opinion_modifier = {
					who = from
					modifier = opinion_new_contact
				}
				from = {
					has_opinion_modifier = {
						who = prev
						modifier = opinion_new_contact
					}
				}
			}
		}
	}

	possible = {
		homicidal_diplomacy_restrictions = { mirror = yes } # Undercoat
		pompous_diplomacy_restrictions = yes # Undercoat
		custom_tooltip = { # EED replaces neutral or better block
			fail_text = "requires_neutral_or_recipient_pacifist"

			OR = {
				opinion_level = { who = from level >= neutral }
				AND = {
					opinion_level = { who = from level >= poor }
					from_has_compatible_ethics = yes
				}
				is_pacifist = yes 
				has_policy_flag = diplo_stance_isolationist
				has_policy_flag = diplo_stance_secretive
				FROM = {
					OR = {
						is_pacifist = yes
						has_policy_flag = diplo_stance_isolationist
						has_policy_flag = diplo_stance_secretive
					}
				}
			}
		}
	}

	ai_acceptance = {
		modifier = { # EED
			add = -75
			OR = {
				has_opinion_modifier = {
					who = from
					modifier = opinion_new_contact
				}
				from = {
					has_opinion_modifier = {
						who = prev
						modifier = opinion_new_contact
					}
				}
			}
			desc = opinion_new_contact
		}
	}
}

## Form Research Agreement
# Merge between Vassals Expanded, EED, Scripted Trigger Undercoat
action_form_research_agreement = {
	icon = "GFX_diplomacy_status_research_agreement"
	diplo_view_acceptance_icon = yes
	should_notify_all_communications = no # Viable Feudalism yes -> no
	requires_actor_independence = no # Viable Feudalism yes -> no
	requires_recipient_independence = no # Viable Feudalism yes -> no
	AI_acceptance_base_value = -50
	action_type = positive

	should_ai_propose = { # EED
		weight = 1
		modifier = {
			factor = 0
			exists = from
			OR = {
				has_opinion_modifier = {
					who = from
					modifier = opinion_new_contact
				}
				from = {
					has_opinion_modifier = {
						who = prev
						modifier = opinion_new_contact
					}
				}
			}
		}
	}

	potential = {
		hidden_trigger = {
			is_playable = yes # Undercoat
			from = { is_playable = yes } # Undercoat
		}
	}

	possible = {
		homicidal_diplomacy_restrictions = { mirror = yes } # Undercoat
		inwards_perfection_diplomacy_restrictions = { mirror_with_intel = yes } # Undercoat
		pompous_diplomacy_restrictions = yes # Undercoat
		custom_tooltip = {
			fail_text = "federation_actor_no_separate_treaties"
			NOT = {
				AND = {
					has_federation = yes
					federation = { has_federation_law = treaties_separate_no }
					NOT = { federation = { any_member = { is_same_value = root.from } } }
				}
			}
		}
		custom_tooltip = {
			fail_text = "federation_recipient_no_separate_treaties"
			from = {
				NOT = {
					AND = {
						has_federation = yes
						federation = {
							has_federation_law = treaties_separate_no
						}
						NOT = { federation = { any_member = { is_same_value = root } } }
					}
				}
			}
		}
		custom_tooltip = {
			fail_text = "federation_automatic_research"
			NOT = {
				AND = {
					has_federation = yes
					federation = { any_member = { is_same_value = root.from } }
					federation = { has_federation_perk = research_federation_passive }
				}
			}
		}
		custom_tooltip = { # EED replaces the good opinion block
			fail_text = "requires_good_opinion_or_materialist"

			OR = {
				opinion_level = { who = from level >= good }
				AND = {
					opinion_level = { who = from level >= neutral }
					from_has_compatible_ethics = yes
				}
				is_materialist = yes
				is_machine_empire = yes
				is_civic_materialist = yes
				FROM = {
					OR = {
						is_materialist = yes
						is_machine_empire = yes
						is_civic_materialist = yes
					}
				}
			}
		}
		custom_tooltip = {
			fail_text = not_allowed_for_protectorate
			NOT = {
				OR = {
					FROM = {
						is_subject = yes
						any_agreement = { agreement_preset = preset_protectorate }
					}
					AND = {
						is_subject = yes
						any_agreement = { agreement_preset = preset_protectorate }
					}
				}
			}
		}
	}

	ai_acceptance = {
		modifier = { # EED
			add = -75
			OR = {
				has_opinion_modifier = {
					who = from
					modifier = opinion_new_contact
				}
				from = {
					has_opinion_modifier = {
						who = prev
						modifier = opinion_new_contact
					}
				}
			}
			desc = opinion_new_contact
		}
	}
}

## Guarantee Independence
# Merge between Viable Feudalism, EED, Scripted Trigger Undercoat
action_guarantee_independence = {
	icon = "GFX_diplomacy_status_guarantee"
	auto_accepted = no
	diplo_view_acceptance_icon = yes
	should_show_auto_accept_message_recipient = no
	should_notify_all_communications = yes
	requires_recipient_independence = yes
	requires_actor_independence = no # Viable Feudalism yes -> no
	action_type = positive

	potential = {
		# Cannot guarantee if you are in an alliance
		hidden_trigger = {
			NAND = {
				exists = alliance
				alliance = { NOT = { has_federation_type = vf_ef_federation } } # Viable Feudalism
			}
		}

		# Cannot guarantee if they are in an alliance
		hidden_trigger = {
			exists = from
			from = {
				NOT = {
					exists = alliance
				}
			}
		}

		# Already guaranteeing
		hidden_trigger = {
			exists = from
			NOT = {
				is_guaranteeing = from
			}
		}

		# Defensive Pact
		hidden_trigger = {
			exists = from
			NOT = {
				has_defensive_pact = from
			}
		}

		# Cannot guarantee if target is already a subject.
		hidden_trigger = {
			FROM = { is_subject = no }
		}

		hidden_trigger = {
			OR = {
				is_subject = no
				is_auto_state = yes # Viable Feudalism
			}
		}

		# Target is not overlord.
		hidden_trigger = {
			NOT = { has_overlord = FROM }
		}
	}

	possible = {
		homicidal_diplomacy_restrictions = { mirror = yes } # Undercoat scripted trigger
		inwards_perfection_diplomacy_restrictions = { mirror = no }
		pompous_diplomacy_restrictions = yes
		custom_tooltip = {
			fail_text = "requires_neutral_or_better_opinion"

			OR = {
				opinion_level = { who = from level >= neutral }
				AND = { # EED
					opinion_level = { who = from level >= poor }
					from_has_compatible_ethics = yes
				}
			}
		}
		# Shared Borders
		get_border_test_defense = yes # Viable Feudalism
	}
}

## Invite To Federation
# Merge between Vassals Expanded, Viable Feudalism, EED, We Require Borders, Scripted Trigger Undercoat
action_invite_to_federation = {
	icon = "GFX_diplomacy_status_federation"
	requires_actor_peace = yes
	requires_recipient_peace = yes
	requires_alliance_vote = yes
	diplo_view_acceptance_icon = yes
	should_notify_all_communications = yes
	AI_acceptance_base_value = -50
	action_type = positive
	should_show_auto_accept_message_recipient = yes
	should_open_auto_accept_message_recipient = yes
	should_notify_auto_recipient_on_vote_fail = yes
	requires_recipient_independence = no # Viable Feudalism yes -> no

	should_ai_propose = { # EED
		weight = 1
		modifier = {
			factor = 0
			exists = from
			OR = {
				has_opinion_modifier = {
					who = from
					modifier = opinion_new_contact
				}
				from = {
					has_opinion_modifier = {
						who = prev
						modifier = opinion_new_contact
					}
				}
			}
		}
	}

	potential = {
		hidden_trigger = {
			is_fallen_machine_empire = no
			from = { is_fallen_machine_empire = no }
		}
		hidden_trigger = {
			if = { # Vassals Expanded
				limit = { FROM = { is_subject = yes } }
				is_overlord_to = FROM
			}
			OR = { # Viable Feudalism
				has_federation = no
				federation = { NOT = { has_federation_type = vf_ef_federation } }
			}
		}
	}

	possible = {
		if = {
			limit = {
				has_federation = no
				is_subject = yes
			}
			custom_tooltip = {
				fail_text = requires_not_subject_to_start_federation
				OR = {
					is_subject = no
					overlord = { is_same_value = from }
				}
			}
		}
		custom_tooltip = {
			fail_text = requires_not_subject_or_overlord_asking
			from = {
				OR = {
					is_subject = no
					overlord = { is_same_value = root }
				}
			}
		}
		if = {
			limit = {
				has_federations_dlc = no # EED
				has_federation = no
				is_playable = yes
			}
			custom_tooltip = {
				fail_text = requires_tradition_the_federation
				has_tradition = tr_diplomacy_the_federation
			}
		}
		else_if = { # EED
			limit = {
				has_federations_dlc = yes
				has_federation = no
				is_playable = yes
			}
			custom_tooltip = {
				fail_text = requires_tradition_the_federation
				OR = {
					has_active_tradition = tr_diplomacy_the_federation
					has_active_tradition = tr_diplomacy_the_federation_dlc
					has_active_tradition = tr_mercantile_federations_finish
					has_active_tradition = tr_discovery_federations_finish
					has_active_tradition = tr_unyielding_federations_finish
					has_active_tradition = tr_domination_federations_finish
					has_active_tradition = tr_harmony_federations_finish
				}
			}
		}

		homicidal_diplomacy_restrictions = { mirror = yes } # Undercoat
		inwards_perfection_diplomacy_restrictions = { mirror_with_intel = yes } # Undercoat
		pompous_diplomacy_restrictions = yes # Undercoat
		custom_tooltip = { # EED replaces excellent opinion block
			fail_text = "requires_excellent_opinion_or_cooperative"

			OR = {
				from = { is_same_value = prevprev } # Bypass opinion check if we are proposing on behalf of recipient
				opinion_level = { who = from level >= excellent }
				AND = {
					opinion_level = { who = from level >= good }
					from_has_compatible_ethics = yes
				}
				has_policy_flag = "diplo_stance_cooperative"
				from = { has_policy_flag = "diplo_stance_cooperative" }
			}
		}
		# Members of the Galactic Empire can't be in federations
		custom_tooltip = {
			fail_text = "requires_actor_recipient_not_in_galactic_empire"
			NAND = {
				has_galactic_emperor = yes
				OR = {
					is_galactic_community_member = yes
					from = { is_galactic_community_member = yes }
				}
			}
		}
		# Shared Borders
		get_border_test = yes # We Require Borders
	}

	ai_acceptance = {
		modifier = { # EED
			add = -100
			OR = {
				has_opinion_modifier = {
					who = from
					modifier = opinion_new_contact
				}
				from = {
					has_opinion_modifier = {
						who = prev
						modifier = opinion_new_contact
					}
				}
			}
			desc = opinion_new_contact
		}
	}
}

## Kick From Federation
# Merge between Viable Feudalism, EED, MECR, Co-Op In Teams
action_kick_from_federation = {
	icon = "GFX_diplomacy_status_federation"
	auto_accepted = yes
	should_show_auto_accept_message_recipient = yes
	requires_actor_peace = yes
	requires_recipient_peace = yes
	requires_alliance_vote = yes
	requires_unanimous_vote = no
	diplo_view_acceptance_icon = yes
	should_notify_all_communications = yes
	AI_acceptance_base_value = -50
	action_type = aggressive
	requires_recipient_independence = no # Viable Feudalism yes -> no

	potential = {
		custom_tooltip = { # Co-Op In Teams
			fail_text = "cannot_kick_coop_partner"
			OR = {
				has_global_flag = you_can_leave_federations
				from = { NOT = { has_country_flag = has_chosen_federation } }	
			}
        }
		hidden_trigger = {
			NAND = {
				is_subject = yes
				has_overlord = FROM
			}
			NOT = { FROM = { is_subject = yes } } # EED
		}
		hidden_trigger = { # MECR
			NAND = {
				exists = federation
				federation = {
					has_federation_perk = galactic_confederation_passive
					has_federation_law = kick_members_senate_confederation
				}
			}
		}
	}

	proposable = {
		custom_tooltip = { # MECR
			fail_text = "imperium_federation_can_not_kick"
			NOT = { federation = { has_federation_perk = imperium_federation_passive } }
		}
		custom_tooltip = { # MECR
			fail_text = "galactic_confederation_can_not_kick_the_custodian"
			NAND = {
				federation = { has_federation_perk = galactic_confederation_passive }
				from = { is_galactic_custodian = yes }
			}
		}
		custom_tooltip = { # MECR
			fail_text = "galactic_confederation_can_not_kick_council_member"
			NAND = {
				federation = { has_federation_perk = galactic_confederation_passive }
				from = { is_part_of_galactic_council = yes }
			}
		}
		custom_tooltip = {
			fail_text = requires_federation_leader_exists
			federation = { federation_election_underway = no }
		}
	}
}

## Leave Federation
# Merge between MECR, Co-Op
action_leave_federation = {
	icon = "GFX_diplomacy_status_federation"
	auto_accepted = yes
	requires_actor_peace = yes
	show_to_alliance_members = yes
	should_notify_all_communications = yes
	action_type = negative # MECR

	# We do not want the AI to leave federations because it does not like its subjects
	should_ai_propose = { # MECR
		weight = 1
		modifier = {
			factor = 0
			exists = from
			from = { is_subject = yes }
		}
		modifier = { # MECR
			factor = 0
			NOT = { has_ascension_perk = ap_become_the_crisis }
			federation = { has_federation_perk = galactic_confederation_passive }
		}
	}

	potential = {
		hidden_trigger = { # MECR
			is_subject = no
		}
        custom_tooltip = { # Co-Op
			fail_text = "cannot_leave_coop_partner"
			or = {
				has_global_flag = you_can_leave_federations
				and = {
					from = { NOT = { has_country_flag = has_chosen_federation } }
					NOT = { has_country_flag = has_chosen_federation } 
				}
			}
        }
	}

	proposable = { # MECR
		if = {
			limit = { federation = { has_federation_perk = galactic_confederation_passive } }
			custom_tooltip = "will_make_us_diplo_weight_mult_n0_5"
			is_galactic_custodian = no
			is_part_of_galactic_council = no
		}
		custom_tooltip = {
			fail_text = requires_federation_leader_exists
			federation = { federation_election_underway = no } #messes up federation election chains
		}
	}
}

## Make Rival
# Merge between Bug Branch, EED, Silfae's Portraits, Scripted Trigger Undercoat
action_make_rival = {
	icon = "GFX_diplomacy_status_rivalry"
	auto_accepted = yes
	requires_actor_independence = no
	requires_recipient_independence = no
	should_show_auto_accept_message_recipient = yes
	should_notify_all_communications = yes
	action_type = aggressive

	potential = {
		hidden_trigger = {
			is_fallen_machine_empire = no
			from = { is_fallen_machine_empire = no }
		}

		# Disable against fallen empires for subjects.
		# Can't be rivals with your overlord or their other subjects.
		hidden_trigger = {
			NAND = {
				is_subject = yes
				FROM = {
					OR = {
						is_fallen_empire = yes
						is_overlord_to = ROOT
						has_overlord = ROOT.overlord
					}
				}
			}
		}
		# Can't be rivals with your subjects.
		hidden_trigger = {
			NOT = {
				FROM = {
					is_subject = yes
					has_overlord = ROOT
				}
			}
		}

		custom_tooltip = grants_humiliation_cb_originator
	}

	possible = {
		homicidal_diplomacy_restrictions = { mirror = no } # Undercoat
		machine_assimilator_diplomacy_restrictions = { mirror = no } # Undercoat
		inwards_perfection_diplomacy_restrictions = { mirror = no } # Undercoat
		custom_tooltip = { # EED adjusts the conditions of this block
			fail_text = "requires_terrible_opinion_or_supremacist"
			OR = {
				opinion_level = { who = from level <= terrible }
				AND = {
					opinion_level = { who = from level <= poor }
					from_has_antagonistic_ethics = yes
				}
				from = { is_at_war_with = prev }
				has_policy_flag = "diplo_stance_supremacist"
				from = { has_policy_flag = "diplo_stance_supremacist" }
				is_fallen_empire = yes
				from = { is_fallen_empire = yes }
				from = { is_rival = prev }
			}
		}
		custom_tooltip = { # Bug Branch
			is_bugged_universalism = no
		}
		if = { # Silfae's Portraits
			limit = { has_country_flag = abandoned_peepboops@from }
			custom_tooltip = {
				fail_text = requires_recipient_not_peepboops_make_rival
				from = { NOT = { has_country_flag = is_peepboops@prev } }
			}
		}
		else_if = { # Silfae's Portraits
			limit = { has_country_flag = is_peepboops@from }
			custom_tooltip = {
				fail_text = requires_actor_not_peepboops_make_rival
				from = { NOT = { has_country_flag = abandoned_peepboops@prev } }
			}
		}
	}

	on_accept = {
		hidden_effect = {
			check_casus_belli_valid = {
				target = from
				type = cb_humiliation
			}
		}
	}
}

## Open Technological Enlightenment
# Merge between Gigastructural Engineering, EED, Origins of Civilization, Scripted Trigger Undercoat
action_open_technological_enlightenment = {
	icon = "GFX_diplomacy_open_technological_enlightenment"
	diplo_view_acceptance_icon = yes
	AI_acceptance_base_value = -50
	action_type = positive
	potential = {
		hidden_trigger = {
			is_playable = yes
			from = {
				is_country_type = primitive
				NOT = { has_country_flag = @diplo_flag } # Gigastructural Engineering
				current_awareness_level = full
				NOR = {
					is_under_open_technological_enlightenment = root
					OR = { 
						has_country_flag = solarpunk_country
						has_country_flag = primitives_fanatic_purifier # EED
					}
				}
			}
		}
	}

	possible = {
		custom_tooltip = {
			fail_text = "requires_recipient_not_invaded"
			NOT = { is_hostile = from }
		}
		custom_tooltip = {
			fail_text = "requires_recipient_not_fotd_seperatist"
			from = { NOT = { has_country_flag =  fotd_seperatist_country@root } }
		}
		custom_tooltip = {
			fail_text = "requires_recipient_not_tech_frozen"
			from = { NOT = { has_country_flag =  tech_frozen } }
		}
		homicidal_diplomacy_restrictions = { mirror = yes } # Undercoat
		inwards_perfection_diplomacy_restrictions = { mirror_with_intel = yes } # Undercoat
		custom_tooltip = {
			fail_text = "ACTION_CANNOT_INTERFERE_POLICY"
			OR = { 
				has_policy_flag = interference_subtle
				has_policy_flag = interference_active
			}
		}
		custom_tooltip = {
			fail_text = "ACTION_CANNOT_ENLIGHTEN_POLICY"
			has_policy_flag = enlightenment_allowed
		}
	}
	
	on_accept = {
		hidden_effect = {
			from = {
				set_country_flag = open_technological_enlightenment_pact
				# set a flag necessary for the Enlightened Times achievement
				if = {
					limit = {
						pre_ftl_ancient_era = yes
					}
					set_country_flag = started_enlightening_from_ancient_era
				}
				capital_scope.observation_outpost = {
					set_event_locked = yes
				}
			}
		}
	}
	
	should_ai_propose = {
		weight = 0

		modifier = {
			add = 1
			has_ai_personality_behaviour = uplifter
			NAND = { # Origins of Civilization
				from = { is_robot_empire = yes }
				NOR = {
					has_ai_personality_behaviour = robot_liberator
					is_minamar = yes
				}
			}
		}
		modifier = { # Origins of Civilization
			add = 1
			has_country_flag = scion_master@from
		}
	}

	ai_acceptance = {
		modifier = {
			add = -100
			capital_scope = {
				has_modifier = culture_shock_diplomacy
			}
			desc = NO_DIPLOMATIC_CULTURE_SHOCK
		}
		modifier = {
			add = -1000
			capital_scope = {
				has_modifier = pre_ftl_distrustful
			}
			desc = pre_ftl_distrustful
		}
		modifier = { # Origins of Civilization
			add = 2000
			has_country_flag = scion_of@from
			desc = origin_scion
		}
	}
}

## Pledge Secret Fealty
# Merge between EED, We Require Borders, Scripted Trigger Undercoat
action_pledge_secret_fealty = {
	icon = "GFX_diplomacy_status_secret_fealty"
	auto_accepted = yes
	diplo_view_acceptance_icon = no
	requires_actor_independence = no
	requires_recipient_independence = yes
	requires_actor_federation_leader = no
	requires_recipient_federation_leader = no
	should_show_accept_message = no
	should_show_auto_accept_message_recipient = yes
	should_open_auto_accept_message_recipient = yes
	should_show_auto_accept_message_actor = no
	should_notify_all_communications = no
	action_type = positive
	possible = {
		custom_tooltip = {
			fail_text = recent_failed_betrayal_subject
			NOR = {
				has_modifier = failed_betrayal
				has_modifier = failed_betrayal_status_quo
			}
		}
		pompous_diplomacy_restrictions = yes # Scripted Trigger Undercoat
		homicidal_diplomacy_restrictions = { mirror_with_intel = yes } # Undercoat
		# Shared Borders
		get_border_test = yes # We Require Borders
	}
}

## Pre-FTL Trade
# Merge between Gigastructural Engineering, EED, Scripted Trigger Undercoat
action_pre_ftl_trade = {
	icon = "GFX_diplomacy_pre_ftl_trade"
	diplo_view_acceptance_icon = yes
	AI_acceptance_base_value = -50
	action_type = positive
	potential = {
		hidden_trigger = {
			has_first_contact_dlc = yes
			is_country_type = default
			from = {
				is_country_type = primitive
				NOT = { has_country_flag = @diplo_flag } # Gigastructural Engineering
				NOT = { has_pre_ftl_trade = root }
				current_awareness_level = full
				NOT = { has_country_flag =  fotd_seperatist_country@root }
			}
		}
	}
	
	possible = {
		custom_tooltip = {
			fail_text = "requires_recipient_not_invaded"
			NOT = { is_hostile = from }
		}
		homicidal_diplomacy_restrictions = { mirror = yes } # Undercoat
		inwards_perfection_diplomacy_restrictions = { mirror_with_intel = yes } # Undercoat
		custom_tooltip = {
			fail_text = "ACTION_CANNOT_INTERFERE_POLICY"
			OR = { 
				has_policy_flag = interference_subtle
				has_policy_flag = interference_active
			}
		}
	}

	on_accept = {
		hidden_effect = {
			from = {
				capital_scope.observation_outpost = {
					add_modifier = {
						modifier = preftl_action_trade_pact
					}
				}
				if = { # EED
					limit = {
						has_country_flag = solarpunk_country
					}
					solar_system = {
						every_system_planet = {
							limit = { has_observation_outpost = yes }
							observation_outpost = {
								add_modifier = {
									modifier = preftl_action_trade_pact
								}
							}
						}
					}
				}
				capital_scope.observation_outpost = {
					set_event_locked = yes
				}
			}
		}
	}
	
	should_ai_propose = {
		weight = 0

		modifier = {
			add = 1
			has_ai_personality_behaviour = uplifter
		}

		modifier = {
			add = 1
			has_corporate_government = yes
		}
	}

	ai_acceptance = {
		modifier = {
			add = -100
			capital_scope = {
				has_modifier = culture_shock_diplomacy
			}
			desc = NO_DIPLOMATIC_CULTURE_SHOCK
		}
		modifier = {
			add = -1000
			capital_scope = {
				has_modifier = pre_ftl_distrustful
			}
			desc = pre_ftl_distrustful
		}
	}
}

## Propose Secret Fealty
# Merge between EED, We Require Borders, Scripted Trigger Undercoat
action_propose_secret_fealty = {
	icon = "GFX_diplomacy_status_secret_fealty"
	auto_accepted = no
	diplo_view_acceptance_icon = yes
	requires_recipient_independence = no
	requires_actor_independence = yes
	requires_actor_federation_leader = no
	requires_recipient_federation_leader = no
	should_notify_all_communications = no
	action_type = neutral
	possible = {
		custom_tooltip = {
			fail_text = recent_failed_betrayal_overlord
			NOT = {
				FROM = {
					OR = {
						has_modifier = failed_betrayal
						has_modifier = failed_betrayal_status_quo
					}
				}
			}
		}
		pompous_diplomacy_restrictions = yes # Undercoat
		homicidal_diplomacy_restrictions = { mirror_with_intel = yes } # Undercoat
		# Shared Borders
		get_border_test = yes # We Require Borders
	}
}

## Release Subject
# Merge between MECR, Civic: Organic Zealots
action_release_subject = {
	icon = "GFX_diplomacy_status_has_vassal"
	requires_recipient_independence = no
	auto_accepted = yes
	should_notify_all_communications = yes
	should_show_auto_accept_message_recipient = yes
	action_type = positive

	potential = { # MECR
		NAND = {
			has_federation = yes
			federation = { has_federation_perk = imperium_provinces }
			from = { is_imperial_province_with_custom_tooltip = yes }
		}
	}
	
	on_accept = { # Civic: Organic Zealots
		hidden_effect = {
			from = {
				fire_on_action = {
					on_action = on_becoming_independent
					scopes = {
						from = root
					}
				}
			}
		}
	}
}

## Reveal Presence
# Merge between Gigastructural Engineering, EED, Origins of Civilization, Scripted Trigger Undercoat
action_reveal_presence = {
	icon = "GFX_diplomacy_reveal_presence"
	auto_accepted = yes
	sound = fc_ui_reveal_yourself_button
	
	potential = {
		hidden_trigger = {
			is_country_type = default
			from = {
				is_country_type = primitive
				NOT = { has_country_flag = @diplo_flag } # Gigastructural Engineering
				NOT = { current_awareness_level = full }
			}
		}
	}

	possible = {
		custom_tooltip = {
			fail_text = "requires_not_ongoing_singularity_situation"
			NOT = {
				has_active_event = { action.2 }
			}
		}

		custom_tooltip = {
			fail_text = "requires_not_ongoing_singularity_situation"
			NOT = {
				any_situation = { is_situation_type = situation_pre_ftl_singularity }
			}
		}
		custom_tooltip = {
			fail_text = "requires_not_ongoing_observation_event_chain"
			NOT = {
				from = {
					any_situation = {
						has_situation_flag = has_ongoing_observation_event_chain
					}
				}
			}
		}
		homicidal_diplomacy_restrictions = { mirror = yes } # Undercoat
		inwards_perfection_diplomacy_restrictions = { mirror_with_intel = yes } # Undercoat
		custom_tooltip = {
			fail_text = "ACTION_CANNOT_INTERFERE_POLICY"
			NOT = { has_policy_flag = interference_not_allowed }
		}
		if = {
			limit = {
				has_policy_flag = interference_subtle
				from = { NOT = { current_awareness_level = high } }
			}
			custom_tooltip = {
				fail_text = "ACTION_CANNOT_LOW_AWARENESS"
				always = no
			}
		}
	}
	
	on_accept = {
		from = {
			switch = {
				trigger = current_awareness_level
				none = {
					capital_scope = {
						add_modifier = {
							modifier = culture_shock_diplomacy
							years = 50
						}
					}
				}
				low = {
					capital_scope = {
						add_modifier = {
							modifier = culture_shock_diplomacy
							years = 30
						}
					}
				}
				medium = {
					capital_scope = {
						add_modifier = {
							modifier = culture_shock_diplomacy
							years = 15
						}
					}
				}
				high = {
					capital_scope = {
						add_modifier = {
							modifier = culture_shock_diplomacy
							years = 5
						}
					}
				}
			}
		}
		hidden_effect = {
			country_event = { id = first_contact.6000 scopes = { from = from } }
		}
	}
	
	should_ai_propose = {
		weight = 0

		modifier = {
			add = 1
			has_ai_personality_behaviour = uplifter
			NAND = { # Origins of Civilization
				from = { is_robot_empire = yes }
				NOR = {
					has_ai_personality_behaviour = robot_liberator
					is_minamar = yes
				}
			}
		}
	}
}

## Societal Enlightenment
# Merge between Gigastructural Engineering, EED, Origins of Civilization, Scripted Trigger Undercoat
action_societal_enlightenment = {
	icon = "GFX_diplomacy_societal_enlightenment"
	diplo_view_acceptance_icon = yes
	AI_acceptance_base_value = -50
	action_type = negative
	potential = {
		hidden_trigger = {
			OR = {
				has_utopia = yes
				has_first_contact_dlc = yes
			}
			is_playable = yes
			from = {
				is_country_type = primitive
				NOT = { has_country_flag = @diplo_flag } # Gigastructural Engineering
				NOR = { 
					is_under_societal_enlightenment = root
					OR = { 
						has_country_flag = solarpunk_country
						has_country_flag = primitives_fanatic_purifier # EED
					}
				}
				current_awareness_level = full
			}
		}
	}

	possible = {
		custom_tooltip = {
			fail_text = "requires_recipient_not_invaded"
			NOT = { is_hostile = from }
		}
		custom_tooltip = {
			fail_text = "requires_recipient_not_fotd_seperatist"
			from = { NOT = { has_country_flag =  fotd_seperatist_country@root } }
		}
		homicidal_diplomacy_restrictions = { mirror = yes } # Undercoat scripted trigger
		inwards_perfection_diplomacy_restrictions = { mirror_with_intel = yes }
		custom_tooltip = {
			fail_text = "requires_actor_not_gestalt_consciousness"
			is_gestalt = no
		}
		custom_tooltip = {
			fail_text = "requires_recipient_not_gestalt_consciousness"
			from = { is_gestalt = no }
		}
		custom_tooltip = {
			fail_text = "ACTION_CANNOT_INTERFERE_POLICY"
			OR = { 
				has_policy_flag = interference_subtle
				has_policy_flag = interference_active
			}
		}
	}
	
	on_accept = {
		hidden_effect = {
			from = {
				set_country_flag = preftl_societal_enlightenment_pact
				set_country_flag = preftl_societal_enlightenment_pact_with@root
				capital_scope.observation_outpost = {
					set_event_locked = yes
				}
			}
		}
	}
	

	should_ai_propose = {
		weight = 0

		modifier = {
			add = 1
			has_ai_personality_behaviour = uplifter
		}
		modifier = { # Origins of Civilization
			add = 1
			has_country_flag = scion_master@from
		}
	}

	ai_acceptance = {
		modifier = {
			add = -100
			capital_scope = {
				has_modifier = culture_shock_diplomacy
			}
			desc = NO_DIPLOMATIC_CULTURE_SHOCK
		}
		modifier = {
			add = -1000
			capital_scope = {
				has_modifier = pre_ftl_distrustful
			}
			desc = pre_ftl_distrustful
		}
		modifier = { # Origins of Civilization
			add = 2000
			has_country_flag = scion_of@from
			desc = origin_scion
		}
	}
}

## Stop Open Technological Enlightenment
# Merge between Gigastructural Engineering, EED, Scripted Trigger Undercoat
action_stop_open_technological_enlightenment = {
	icon = "GFX_diplomacy_open_technological_enlightenment"
	auto_accepted = yes
	should_show_auto_accept_message_recipient = yes
	action_type = negative
	
	potential = {
		hidden_trigger = {
			is_playable = yes
			from = {
				is_country_type = primitive
				NOT = { has_country_flag = @diplo_flag } # Gigastructural Engineering
				is_under_open_technological_enlightenment = root
			}
		}
	}
	
	on_accept = {
		hidden_effect = {
			from = {
				remove_country_flag = open_technological_enlightenment_pact
				if = {
					limit = {
						has_country_flag = started_enlightening_from_ancient_era
					}
					remove_country_flag = started_enlightening_from_ancient_era
				}
				if = {
					limit = {
						NOR = {
							has_country_flag = preftl_societal_enlightenment_pact
							has_country_flag = open_technological_enlightenment_pact
							capital_scope.observation_outpost = {
								has_modifier = preftl_action_trade_pact
							}
						}
					}
					capital_scope.observation_outpost = {
						set_event_locked = no
					}
				}
			}
		}
	}
}

## Stop Pre-FTL Trade
# Merge between Gigastructural Engineering, EED, Scripted Trigger Undercoat
action_stop_pre_ftl_trade = {
	icon = "GFX_diplomacy_pre_ftl_trade"
	auto_accepted = yes
	should_show_auto_accept_message_recipient = yes
	action_type = negative
	
	potential = {
		hidden_trigger = {
			is_playable = yes
			from = {
				is_country_type = primitive
				NOT = { has_country_flag = @diplo_flag } # Gigastructural Engineering
				has_pre_ftl_trade = root
			}
		}
	}
	
	on_accept = {
		hidden_effect = {
			from = {
				capital_scope.observation_outpost = {
					remove_modifier = preftl_action_trade_pact
				}
				if = {
					limit = {
						has_country_flag = solarpunk_country
					}
					solar_system = {
						every_system_planet = {
							limit = { has_observation_outpost = yes }
							observation_outpost = {
								remove_modifier = preftl_action_trade_pact
							}
						}
					}
				}
				if = {
					limit = {
						NOR = {
							has_country_flag = preftl_societal_enlightenment_pact
							has_country_flag = open_technological_enlightenment_pact
							capital_scope.observation_outpost = {
								has_modifier = preftl_action_trade_pact
							}
						}
					}
					capital_scope.observation_outpost = {
						set_event_locked = no
					}
				}
			}
		}
	}
}

## Stop Societal Enlightenment
# Merge between Gigastructural Engineering, EED, Scripted Trigger Undercoat
action_stop_societal_enlightenment = {
	icon = "GFX_diplomacy_societal_enlightenment"
	auto_accepted = yes
	should_show_auto_accept_message_recipient = yes
	action_type = positive
	potential = {
		hidden_trigger = {
			is_playable = yes
			from = {
				is_country_type = primitive
				NOT = { has_country_flag = @diplo_flag } # Gigastructural Engineering
				is_under_societal_enlightenment = root
			}
		}
	}

	on_accept = {
		hidden_effect = {
			from = {
				remove_country_flag = preftl_societal_enlightenment_pact
				remove_country_flag = preftl_societal_enlightenment_pact_with@root
				if = {
					limit = {
						NOR = {
							has_country_flag = preftl_societal_enlightenment_pact
							has_country_flag = open_technological_enlightenment_pact
							capital_scope.observation_outpost = {
								has_modifier = preftl_action_trade_pact
							}
						}
					}
					capital_scope.observation_outpost = {
						set_event_locked = no
					}
				}
			}
		}
	}
}

## Support Independence
# Merge between EED, We Require Borders, Scripted Trigger Undercoat
action_support_independence = {
	icon = "GFX_diplomacy_status_support_independence"
	auto_accepted = yes
	should_notify_all_communications = yes
	requires_recipient_independence = no
	action_type = positive

	potential = {
		hidden_trigger = {
			exists = from
			NOT = {
				from = {
					exists = overlord
					overlord = {
						is_same_value = root
					}
				}
			}
		}

		# Actor is subject and has limited diplomacy.
		hidden_trigger = {
			NAND = {
				is_subject = yes
				any_agreement = {
					has_term_value = {
						term = subject_diplomacy
						value = subject_can_not_do_diplomacy
					}
				}
			}
		}
	}

	possible = {
		homicidal_diplomacy_restrictions = { mirror = yes } # Undercoat
		inwards_perfection_diplomacy_restrictions = { mirror = no } # Undercoat
		# Shared Borders
		get_border_test_defense = yes # We Require Borders
	}
}
